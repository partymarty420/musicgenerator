<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Random Music Studio v4</title>
<style>
  :root{
    --bg:#0a0f14; --panel:#111827; --ink:#e6edf3; --muted:#9fb0c3; --accent:#7dd3fc; --accent2:#a78bfa; --good:#86efac; --warn:#fbbf24;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(900px 600px at 90% -20%,#1b2430 0%, #0a0f14 50%) fixed;color:var(--ink)}
  header{padding:16px 18px;border-bottom:1px solid #1f2937;background:linear-gradient(180deg,#121826 0%,#0d1420 100%)}
  h1{margin:0;font-size:18px;letter-spacing:.2px}
  main{display:grid;grid-template-columns:390px 1fr;gap:16px; padding:16px}
  @media(max-width:980px){main{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .controls{padding:16px;display:grid;gap:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row label{font-size:12px;color:var(--muted);min-width:90px}
  .row input[type="range"]{width:150px}
  fieldset{border:1px solid #233143;border-radius:12px;padding:12px}
  legend{padding:0 6px;color:var(--muted);font-size:12px}
  button{appearance:none;border:none;background:#1a2232;color:var(--ink);padding:9px 12px;border-radius:12px;cursor:pointer;font-weight:600;box-shadow:0 2px 0 #0a0d14;transition:transform .05s ease, background .2s ease}
  button:hover{background:#202a3c}
  button:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#22d3ee,#0ea5e9);color:#001218;box-shadow:0 2px 0 #075985}
  .danger{background:linear-gradient(180deg,#ef4444,#dc2626);color:#fff}
  .good{background:linear-gradient(180deg,#34d399,#10b981);color:#02150e}
  select,input[type="number"],.pill,input[type="text"]{background:#0f1520;border:1px solid #233143;color:var(--ink);border-radius:10px;padding:8px 10px}
  .mutetext{color:var(--muted);font-size:12px}
  .kbd{background:#0e1520;border:1px solid #223046;border-radius:8px;padding:1px 6px;font-size:12px;color:var(--muted)}
  .meter{height:8px;background:#0f172a;border-radius:999px;overflow:hidden;border:1px solid #1e293b}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .08s}
  .grid{display:grid;grid-template-columns:repeat(16,1fr);gap:4px}
  .cell{height:28px;border-radius:6px;background:#0c1320;border:1px solid #1c2941;cursor:pointer}
  .cell.on{background:linear-gradient(180deg,#22d3ee33,#a78bfa33);border-color:#3a4f74;box-shadow:inset 0 0 10px #7dd3fc55}
  .workspace{padding:16px;display:grid;gap:16px}
  .lane{display:grid;grid-template-columns:150px 1fr;gap:10px;align-items:center}
  .lane .lane-ctrls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .tag{font-size:11px;color:#a3b6cd;background:#0f172a;border:1px solid #1f2a44;border-radius:999px;padding:2px 8px}
  .led{width:10px;height:10px;border-radius:50%;background:#111827;box-shadow:0 0 8px #000 inset;border:1px solid #1f2937}
  .led.on{background:#10b981;box-shadow:0 0 10px #10b981}
  .kbd-wrap{background:#0b1220;border:1px solid #1f2a44;border-radius:14px;padding:12px}
  .keys{display:flex;position:relative;height:140px}
  .white{width:36px;height:100%;background:#fefefe;border:1px solid #c9d2e0;border-bottom-left-radius:6px;border-bottom-right-radius:6px;position:relative;z-index:1;cursor:pointer}
  .white:active{background:#e7f3ff}
  .black{position:absolute;width:24px;height:84px;background:#151c28;border:1px solid #2b3a57;border-radius:4px;z-index:2;margin-left:-12px;left:27px;cursor:pointer}
  .black:active{background:#26334d}
  .keyname{position:absolute;bottom:6px;left:0;right:0;text-align:center;font-size:10px;color:#334155}
  .kb-row{display:flex;gap:8px;align-items:center;margin-top:8px}
  .pill.small{font-size:11px;padding:4px 8px}
</style>
</head>
<body>
<header>
  <h1>üéπ Random Music Studio v4 ‚Ä¢ Party Marty</h1>
</header>
<main>
  <section class="panel controls">
    <div class="row">
      <button id="startBtn" class="primary">‚ñ∂Ô∏è Start</button>
      <button id="stopBtn" class="danger">‚èπ Stop</button>
      <button id="rndAll" class="good">‚ú® Randomize All</button>
      <span class="spacer"></span>
      <span class="mutetext">CPU</span>
      <div class="meter" style="width:140px"><div class="bar" id="cpubar"></div></div>
    </div>

    <fieldset>
      <legend>Tempo & Feel</legend>
      <div class="row">
        <label>BPM</label><input id="bpm" type="range" min="40" max="200" value="110"/><span id="bpmVal" class="pill">110</span>
        <label>Swing</label><input id="swing" type="range" min="0" max="0.5" step="0.01" value="0.08"/><span id="swingVal" class="pill">0.08</span>
        <label>Humanize ms ¬±</label><input id="humMs" type="range" min="0" max="30" step="1" value="8"/><span id="humMsVal" class="pill">8</span>
        <label>Humanize vel ¬±</label><input id="humVel" type="range" min="0" max="0.6" step="0.02" value="0.18"/><span id="humVelVal" class="pill">0.18</span>
      </div>
    </fieldset>

    <fieldset>
      <legend>Key / Scale</legend>
      <div class="row">
        <label>Root</label><select id="root"></select>
        <label>Scale</label>
        <select id="scale">
          <option value="major">Major</option>
          <option value="minor">Natural Minor</option>
          <option value="pent_major">Pentatonic Major</option>
          <option value="pent_minor">Pentatonic Minor</option>
          <option value="dorian">Dorian</option>
          <option value="mixolydian">Mixolydian</option>
        </select>
        <label>Octave</label><input id="oct" type="number" value="4" min="1" max="7" style="width:70px"/>
      </div>
    </fieldset>

    <fieldset>
      <legend>Lead Synth</legend>
      <div class="row">
        <label>Instrument</label>
        <select id="leadInst">
          <option value="sawtooth" selected>Saw</option>
          <option value="sine">Sine</option>
          <option value="square">Square</option>
          <option value="triangle">Triangle</option>
          <option value="supersaw">SuperSaw</option>
          <option value="pluck">Pluck</option>
          <option value="fm">FM</option>
          <option value="noise">Noise</option>
        </select>
        <label>Vol</label><input id="leadVol" type="range" min="0" max="1.5" step="0.01" value="1.0"/><span id="leadVolVal" class="pill">1.00</span>
        <label>Voicing</label>
        <select id="voicing">
          <option value="uni">Unison</option>
          <option value="oct">Octaves</option>
          <option value="thr">Thirds</option>
          <option value="triad" selected>Triad</option>
          <option value="fif">Fifths</option>
          <option value="six">Sixths</option>
        </select>
      </div>
      <div class="row">
        <label>Delay</label><input id="dlyMix" type="range" min="0" max="0.8" step="0.01" value="0.18"/><span id="dlyMixVal" class="pill">0.18</span>
        <label>Reverb</label><input id="revMix" type="range" min="0" max="1" step="0.01" value="0.25"/><span id="revMixVal" class="pill">0.25</span>
        <label>Chorus</label><input id="choMix" type="range" min="0" max="1" step="0.01" value="0.20"/><span id="choMixVal" class="pill">0.20</span>
      </div>
    </fieldset>

    <fieldset>
      <legend>Melody Generator</legend>
      <div class="row">
        <label>Density</label><input id="melDen" type="range" min="0" max="1" step="0.01" value="0.6"/><span id="melDenVal" class="pill">0.60</span>
        <label>Range (notes)</label><input id="melRange" type="range" min="4" max="16" step="1" value="8"/><span id="melRangeVal" class="pill">8</span>
        <label>Gate</label><input id="melGate" type="range" min="0.05" max="0.9" step="0.01" value="0.35"/><span id="melGateVal" class="pill">0.35</span>
      </div>
      <div class="row">
        <button id="melRnd">üé≤ Randomize Melody</button>
        <button id="melClr">üßπ Clear</button>
        <button id="melRepeat" class="good">üîÅ Toggle Repeat</button><span id="repeatState" class="pill small">On</span>
      </div>
    </fieldset>

    <fieldset>
      <legend>Master / Output</legend>
      <div class="row">
        <label>Master</label><input id="master" type="range" min="0" max="1" step="0.01" value="0.85"/><span id="masterVal" class="pill">0.85</span>
        <div class="spacer"></div><div class="led" id="beatLED"></div><span class="mutetext">Beat</span>
      </div>
      <div class="row">
        <button id="recBtn">‚è∫Ô∏è Record</button>
        <a id="dl" class="mutetext" style="display:none">Download last take</a>
      </div>
    </fieldset>
  </section>

  <section class="panel workspace">
    <h3 style="margin:0">Drum Sequencer</h3>

    <div class="lane">
      <div class="lane-ctrls">
        <span class="tag">Kick</span>
        <select id="kickType"><option value="acoustic">Acoustic</option><option value="808" selected>808</option><option value="clicky">Clicky</option></select>
        <label>Vol</label><input id="kickVol" type="range" min="0" max="1.2" step="0.01" value="1"/>
        <label>Delay</label><input id="kickDly" type="range" min="0" max="1" step="0.01" value="0"/>
        <label>Reverb</label><input id="kickRev" type="range" min="0" max="1" step="0.01" value="0.05"/>
      </div>
      <div id="grid-kick" class="grid"></div>
    </div>

    <div class="lane">
      <div class="lane-ctrls">
        <span class="tag">Snare</span>
        <select id="snrType"><option value="noise" selected>Noise</option><option value="808">808</option><option value="clap">Clap</option></select>
        <label>Vol</label><input id="snrVol" type="range" min="0" max="1.2" step="0.01" value="0.9"/>
        <label>Delay</label><input id="snrDly" type="range" min="0" max="1" step="0.01" value="0.1"/>
        <label>Reverb</label><input id="snrRev" type="range" min="0" max="1" step="0.01" value="0.25"/>
      </div>
      <div id="grid-snr" class="grid"></div>
    </div>

    <div class="lane">
      <div class="lane-ctrls">
        <span class="tag">Hat</span>
        <select id="hatType"><option value="ch">Closed</option><option value="oh" selected>Open</option><option value="sh">Shaker</option></select>
        <label>Vol</label><input id="hatVol" type="range" min="0" max="1.2" step="0.01" value="0.75"/>
        <label>Delay</label><input id="hatDly" type="range" min="0" max="1" step="0.01" value="0.05"/>
        <label>Reverb</label><input id="hatRev" type="range" min="0" max="1" step="0.01" value="0.1"/>
      </div>
      <div id="grid-hat" class="grid"></div>
    </div>

    <div class="lane">
      <div class="lane-ctrls">
        <span class="tag">Perc</span>
        <select id="prcType"><option value="clap">Clap</option><option value="tom" selected>Tom</option><option value="cow">Cowbell</option></select>
        <label>Vol</label><input id="prcVol" type="range" min="0" max="1.2" step="0.01" value="0.8"/>
        <label>Delay</label><input id="prcDly" type="range" min="0" max="1" step="0.01" value="0.12"/>
        <label>Reverb</label><input id="prcRev" type="range" min="0" max="1" step="0.01" value="0.18"/>
      </div>
      <div id="grid-prc" class="grid"></div>
    </div>

    <div class="row">
      <button id="drmRnd">üé≤ Randomize Drums</button>
      <button id="drmClr">üßπ Clear</button>
    </div>

    <h3 style="margin:0">Melody Lane + Keyboard</h3>
    <div class="lane">
      <div class="lane-ctrls">
        <span class="tag">Melody</span>
        <label>Overdub</label><input id="overdub" type="checkbox"/>
        <span class="mutetext">(Play keys to add to loop)</span>
      </div>
      <div id="grid-mel" class="grid"></div>
    </div>

    <div class="kbd-wrap">
      <div id="keyboard" class="keys"></div>
      <div class="kb-row">
        <label>Octave</label><input id="kbOct" type="number" value="4" min="1" max="7" style="width:70px"/>
        <span class="mutetext">Click/tap keys to play. With <b>Overdub</b> on, notes are quantized to the current step and added to the repeating melody.</span>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  // ===== Utilities & Theory =====
  const noteNames=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const scales={
    major:[0,2,4,5,7,9,11],
    minor:[0,2,3,5,7,8,10],
    pent_major:[0,2,4,7,9],
    pent_minor:[0,3,5,7,10],
    dorian:[0,2,3,5,7,9,10],
    mixolydian:[0,2,4,5,7,9,10]
  };
  function midiToFreq(m){return 440*Math.pow(2,(m-69)/12)}
  function clamp(v,min,max){return Math.min(max,Math.max(min,v))}
  function pick(a){return a[Math.floor(Math.random()*a.length)]}

  // ===== DOM =====
  const $=id=>document.getElementById(id);
  const bpm=$('bpm'), swing=$('swing'), humMs=$('humMs'), humVel=$('humVel');
  const bpmVal=$('bpmVal'), swingVal=$('swingVal'), humMsVal=$('humMsVal'), humVelVal=$('humVelVal');
  const rootSel=$('root'), scaleSel=$('scale'), octNum=$('oct');
  const leadInst=$('leadInst'), leadVol=$('leadVol'), leadVolVal=$('leadVolVal'), voicingSel=$('voicing');
  const dlyMix=$('dlyMix'), dlyMixVal=$('dlyMixVal'), revMix=$('revMix'), revMixVal=$('revMixVal'), choMix=$('choMix'), choMixVal=$('choMixVal');
  const melDen=$('melDen'), melDenVal=$('melDenVal'), melRange=$('melRange'), melRangeVal=$('melRangeVal'), melGate=$('melGate'), melGateVal=$('melGateVal');
  const master=$('master'), masterVal=$('masterVal');
  const startBtn=$('startBtn'), stopBtn=$('stopBtn'), rndAll=$('rndAll');
  const beatLED=$('beatLED'), cpubar=$('cpubar');
  const recBtn=$('recBtn'), dl=$('dl');
  const overdub=$('overdub'), kbOct=$('kbOct');

  const grids={
    kick: $('grid-kick'), snr: $('grid-snr'), hat: $('grid-hat'), prc: $('grid-prc'), mel: $('grid-mel')
  };
  const drumCtrl={
    kick:{type:$('kickType'), vol:$('kickVol'), dly:$('kickDly'), rev:$('kickRev')},
    snr:{type:$('snrType'), vol:$('snrVol'), dly:$('snrDly'), rev:$('snrRev')},
    hat:{type:$('hatType'), vol:$('hatVol'), dly:$('hatDly'), rev:$('hatRev')},
    prc:{type:$('prcType'), vol:$('prcVol'), dly:$('prcDly'), rev:$('prcRev')},
  };

  // populate root selector
  noteNames.forEach((n,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=n; rootSel.appendChild(o); }); rootSel.value=0;

  // ===== State =====
  const steps=16; let current16=0, nextNoteTime=0, isPlaying=false, lookahead=null;
  const drums={ kick:Array(steps).fill(false), snr:Array(steps).fill(false), hat:Array(steps).fill(false), prc:Array(steps).fill(false) };
  let melody=Array(steps).fill(null); // base melody (MIDI or null)
  let extra=Array.from({length:steps},()=>[]); // overdub notes per step (array of MIDI)
  let repeatOn=true;

  // ===== Audio Graph =====
  let ctx, masterG, comp, outAnalyser, busDry, delay, dlyGain, rev, revGain, chorus, choGain, mediaDest, mediaRec;
  async function initAudio(){
    if(ctx) return;
    ctx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
    masterG=ctx.createGain(); masterG.gain.value=parseFloat(master.value);
    comp=new DynamicsCompressorNode(ctx,{threshold:-16,knee:20,ratio:3,attack:0.004,release:0.25});

    // sends
    delay=new DelayNode(ctx,{delayTime:0.26}); const fb=ctx.createGain(); fb.gain.value=0.28; delay.connect(fb).connect(delay); dlyGain=ctx.createGain(); dlyGain.gain.value=parseFloat(dlyMix.value);
    rev=ctx.createConvolver(); rev.buffer=makeImpulse(ctx,2.2,2.6); revGain=ctx.createGain(); revGain.gain.value=parseFloat(revMix.value);
    chorus=ctx.createDelay(0.06); chorus.delayTime.value=0.016; const lfo=new OscillatorNode(ctx,{type:'sine',frequency:0.7}); const depth=new GainNode(ctx,{gain:0.008}); lfo.connect(depth).connect(chorus.delayTime); lfo.start(); choGain=ctx.createGain(); choGain.gain.value=parseFloat(choMix.value);

    outAnalyser=ctx.createAnalyser(); outAnalyser.fftSize=1024;

    // mix buses
    busDry=ctx.createGain(); busDry.gain.value=1;
    const sum=ctx.createGain();
    busDry.connect(sum); delay.connect(dlyGain).connect(sum); rev.connect(revGain).connect(sum); chorus.connect(choGain).connect(sum);
    sum.connect(comp).connect(masterG).connect(ctx.destination);
    sum.connect(outAnalyser);

    // recorder
    mediaDest=ctx.createMediaStreamDestination(); masterG.connect(mediaDest);

    startCpuMeter();
  }
  function makeImpulse(ctx, dur, decay){ const len=ctx.sampleRate*dur; const b=ctx.createBuffer(2,len,ctx.sampleRate); for(let ch=0;ch<2;ch++){ const d=b.getChannelData(ch); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/len,decay); } } return b; }

  function voiceOut(){ const g=new GainNode(ctx,{gain:0}); g.connect(busDry); g.connect(delay); g.connect(rev); g.connect(chorus); return g; }
  function envGain(g,t,dur,a=0.004,d=0.06,s=0.35){ const peak=0.9; g.cancelScheduledValues(t); g.setValueAtTime(0.0001,t); g.linearRampToValueAtTime(peak,t+a); g.linearRampToValueAtTime(peak*s,t+a+d); g.linearRampToValueAtTime(0.0001,t+dur); }
  function humanize(t,baseGain){ const ms=parseFloat(humMs.value), vel=parseFloat(humVel.value); return { t: t + ((Math.random()*2-1)*(ms/1000)), g: clamp(baseGain + (Math.random()*2-1)*vel, 0.0001, 2.0) } }

  // ===== Synth: Lead =====
  function playLeadFreq(freq, time, gate){ const {t,g}=humanize(time, parseFloat(leadVol.value)); const type=leadInst.value; const out=voiceOut(); out.gain.setValueAtTime(out.gain.value*g,t); envGain(out.gain,t,gate,0.003,0.05,0.4);
    if(type==='noise'){ const src=ctx.createBufferSource(); const b=ctx.createBuffer(1,ctx.sampleRate*gate,ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; src.buffer=b; const bp=new BiquadFilterNode(ctx,{type:'bandpass',frequency:freq,Q:6}); src.connect(bp).connect(out); src.start(t); src.stop(t+gate+0.1); return; }
    if(type==='supersaw'){ const mix=new GainNode(ctx,{gain:1}); mix.connect(out); const det=[-12,-7,-3,3,7,12]; det.forEach(c=>{ const o=new OscillatorNode(ctx,{type:'sawtooth',frequency:freq}); o.detune.value=c; o.connect(mix); o.start(t); o.stop(t+gate+0.1); }); return; }
    if(type==='pluck'){ const s=new OscillatorNode(ctx,{type:'sine',frequency:freq}); const n=ctx.createBufferSource(); const b=ctx.createBuffer(1,ctx.sampleRate*Math.min(0.2,gate),ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; n.buffer=b; const bp=new BiquadFilterNode(ctx,{type:'bandpass',frequency:freq*2,Q:10}); s.connect(out); n.connect(bp).connect(out); s.start(t); n.start(t); s.stop(t+gate+0.1); n.stop(t+Math.min(0.2,gate)); return; }
    if(type==='fm'){ const car=new OscillatorNode(ctx,{type:'sine',frequency:freq}); const mod=new OscillatorNode(ctx,{type:'sine',frequency:freq*2.2}); const mg=new GainNode(ctx,{gain:120}); mod.connect(mg).connect(car.frequency); car.connect(out); car.start(t); mod.start(t); car.stop(t+gate+0.1); mod.stop(t+gate+0.1); return; }
    const o=new OscillatorNode(ctx,{type:type,frequency:freq}); o.connect(out); o.start(t); o.stop(t+gate+0.1);
  }
  function voicingOffsets(){ const v=voicingSel.value; if(v==='uni')return [0]; if(v==='oct')return [0,12]; if(v==='thr')return [0,4]; if(v==='fif')return [0,7]; if(v==='six')return [0,9]; if(v==='triad')return [0,4,7]; return [0]; }
  function playVoiced(midi, time, gate){ const offs=voicingOffsets(); offs.forEach(o=> playLeadFreq(midiToFreq(midi+o), time, gate) ); }

  // ===== Drums =====
  function drumSend(out, lane){ // per-lane FX send scaling
    const cfg = drumCtrl[lane];
    const d = ctx.createGain(); d.gain.value = parseFloat(cfg.dly.value);
    const r = ctx.createGain(); r.gain.value = parseFloat(cfg.rev.value);
    out.connect(busDry);
    out.connect(d).connect(delay);
    out.connect(r).connect(rev);
  }
  function drumKick(t){ const type=drumCtrl.kick.type.value; const vol=parseFloat(drumCtrl.kick.vol.value); const {t:tt,g}=humanize(t,vol); const o=new OscillatorNode(ctx,{type:'sine',frequency:(type==='808'? 55: (type==='clicky'?80:65))}); const gnode=new GainNode(ctx,{gain:1}); o.connect(gnode); drumSend(gnode,'kick'); o.start(tt); o.frequency.setValueAtTime((type==='clicky'?170: type==='808'?120:150),tt); o.frequency.exponentialRampToValueAtTime((type==='808'?30:40), tt+0.18); gnode.gain.setValueAtTime(g,tt); gnode.gain.exponentialRampToValueAtTime(0.001, tt+(type==='808'?0.45:0.28)); if(type==='clicky'){ const click=ctx.createBufferSource(); const b=ctx.createBuffer(1,ctx.sampleRate*0.02,ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; click.buffer=b; const hp=new BiquadFilterNode(ctx,{type:'highpass',frequency:5000}); const cg=new GainNode(ctx,{gain:g*0.6}); click.connect(hp).connect(cg); drumSend(cg,'kick'); click.start(tt); click.stop(tt+0.02);} o.stop(tt+0.6); }
  function drumSnare(t){ const type=drumCtrl.snr.type.value; const vol=parseFloat(drumCtrl.snr.vol.value); const {t:tt,g}=humanize(t,vol); if(type==='clap'){ for(let i=0;i<3;i++){ const delay= i*0.012; const src=ctx.createBufferSource(); const b=ctx.createBuffer(1,ctx.sampleRate*0.08,ctx.sampleRate); const d=b.getChannelData(0); for(let j=0;j<d.length;j++) d[j]=Math.random()*2-1; src.buffer=b; const hp=new BiquadFilterNode(ctx,{type:'highpass',frequency:1500}); const gg=new GainNode(ctx,{gain:g*(i===0?0.9:0.6)}); src.connect(hp).connect(gg); drumSend(gg,'snr'); src.start(tt+delay); src.stop(tt+delay+0.08);} return; }
    const noise=ctx.createBufferSource(); const b=ctx.createBuffer(1,ctx.sampleRate*0.25,ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; noise.buffer=b; const bp=new BiquadFilterNode(ctx,{type:'bandpass',frequency:(type==='808'?1200:1800),Q:0.8}); const gg=new GainNode(ctx,{gain:g}); noise.connect(bp).connect(gg); drumSend(gg,'snr'); noise.start(tt); gg.gain.setValueAtTime(g,tt); gg.gain.exponentialRampToValueAtTime(0.001, tt+(type==='808'?0.3:0.22)); noise.stop(tt+0.26); }
  function drumHat(t){ const type=drumCtrl.hat.type.value; const vol=parseFloat(drumCtrl.hat.vol.value); const {t:tt,g}=humanize(t,vol); const src=ctx.createBufferSource(); const b=ctx.createBuffer(1,ctx.sampleRate*(type==='oh'?0.25:0.06),ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; src.buffer=b; let node; if(type==='sh'){ node=new BiquadFilterNode(ctx,{type:'bandpass',frequency:4000,Q:2}); } else { node=new BiquadFilterNode(ctx,{type:'highpass',frequency:6000,Q:0.7}); }
    const gg=new GainNode(ctx,{gain:g*(type==='oh'?0.5:0.35)}); src.connect(node).connect(gg); drumSend(gg,'hat'); src.start(tt); gg.gain.setValueAtTime(gg.gain.value,tt); gg.gain.exponentialRampToValueAtTime(0.001, tt+(type==='oh'?0.22:0.07)); src.stop(tt+(type==='oh'?0.25:0.08)); }
  function drumPerc(t){ const type=drumCtrl.prc.type.value; const vol=parseFloat(drumCtrl.prc.vol.value); const {t:tt,g}=humanize(t,vol); if(type==='tom'){ const o=new OscillatorNode(ctx,{type:'sine',frequency:180}); const gg=new GainNode(ctx,{gain:g}); o.connect(gg); drumSend(gg,'prc'); o.start(tt); o.frequency.exponentialRampToValueAtTime(80, tt+0.15); gg.gain.setValueAtTime(g,tt); gg.gain.exponentialRampToValueAtTime(0.001, tt+0.25); o.stop(tt+0.3); return; }
    if(type==='cow'){ const o1=new OscillatorNode(ctx,{type:'square',frequency:540}); const o2=new OscillatorNode(ctx,{type:'square',frequency:800}); const m=new GainNode(ctx,{gain:g*0.6}); o1.connect(m); o2.connect(m); drumSend(m,'prc'); o1.start(tt); o2.start(tt); o1.stop(tt+0.2); o2.stop(tt+0.2); return; }
    // clap default
    drumSnare(tt); }

  // ===== Sequencer =====
  function schedule(){ const secPerBeat=60/parseFloat(bpm.value); const sw=parseFloat(swing.value); while(nextNoteTime < ctx.currentTime + 0.2){ const stepInBeat=current16%4; const swingOffset=((current16%2)===1)? sw*secPerBeat*0.25 : 0; const t=nextNoteTime + swingOffset;
      // Drums
      if(drums.kick[current16]) drumKick(t);
      if(drums.snr[current16]) drumSnare(t);
      if(drums.hat[current16]) drumHat(t);
      if(drums.prc[current16]) drumPerc(t);
      // Melody
      const gate=parseFloat(melGate.value)*secPerBeat; const base=melody[current16]; if(base!==null){ playVoiced(base, t, gate); }
      const extras=extra[current16]; if(extras && extras.length){ extras.forEach(m=> playVoiced(m, t, gate)); }
      if(stepInBeat===0){ beatLED.classList.add('on'); setTimeout(()=>beatLED.classList.remove('on'), 60); }
      advance(); }
  }
  function advance(){ const spb=60/parseFloat(bpm.value); nextNoteTime += 0.25*spb; current16=(current16+1)%steps; if(!repeatOn && current16===0){ melody.fill(null); extra.forEach(a=>a.length=0); } }
  function start(){ if(isPlaying) return; isPlaying=true; current16=0; nextNoteTime=ctx.currentTime+0.05; lookahead=setInterval(schedule,25); }
  function stop(){ if(!isPlaying) return; isPlaying=false; clearInterval(lookahead); lookahead=null; }

  // ===== Randomizers =====
  function buildScale(){ const root=parseInt(rootSel.value), oct=parseInt(octNum.value); const sc=scales[scaleSel.value]; const base=12*(oct+1)+root; return sc.map(s=>base+s); }
  function randomDrums(){ for(let i=0;i<steps;i++){ drums.kick[i]=(i%4===0)||Math.random()<0.12; drums.snr[i]=(i%8===4)|| (Math.random()<0.08 && i%4!==0); drums.hat[i]=Math.random()<0.55; drums.prc[i]=Math.random()<0.22 && i%4!==0; } renderGrids(); }
  function randomMel(){ const dens=parseFloat(melDen.value); const range=parseInt(melRange.value); const scBase=buildScale(); const sc=[]; for(let o=-1;o<=1;o++) sc.push(...scBase.map(n=>n+12*o)); let any=false; for(let i=0;i<steps;i++){ const on=Math.random() < dens * ((i%4===0)?1.1:0.9); if(!on){ melody[i]=null; continue; } const idx=clamp(Math.floor(Math.random()*sc.length + (Math.random()-0.5)*range),0,sc.length-1); melody[i]=sc[idx]; any=true; } if(!any) melody[0]=scBase[0]; }

  // ===== Grids & Keyboard =====
  function renderGrids(){ Object.entries(grids).forEach(([k,el])=>{ el.innerHTML=''; for(let i=0;i<steps;i++){ const c=document.createElement('div'); c.className='cell'+((k==='mel'?(melody[i]!==null):(drums[k][i]))?' on':''); c.title=`${k.toUpperCase()} Step ${i+1}`; c.addEventListener('click',()=>{ if(k==='mel'){ melody[i] = (melody[i]===null)? buildScale()[0] : null; } else { drums[k][i]=!drums[k][i]; } c.classList.toggle('on'); }); el.appendChild(c); } }); }

  function renderKeyboard(){ const kb=$('keyboard'); kb.innerHTML=''; // two octaves starting from kbOct
    const startOct=parseInt(kbOct.value); const totalWhite = 14; // 2 octaves
    const whiteOrder=[0,2,4,5,7,9,11]; const isBlack=s=>[1,3,6,8,10].includes(s%12);
    let x=0; for(let w=0; w<totalWhite; w++){ // compute semitone from start
      const octave = startOct + Math.floor((w + (w>=7? -7:0))/7);
      const semi = whiteOrder[w%7]; const midi = 12*(octave+1) + semi; const key=document.createElement('div'); key.className='white'; key.style.left=(x*36)+'px'; const label=document.createElement('div'); label.className='keyname'; label.textContent=noteNames[semi]+octave; key.appendChild(label); key.onmousedown=()=>playKey(midi); key.ontouchstart=(e)=>{e.preventDefault(); playKey(midi);} ; kb.appendChild(key);
      // add black between certain whites
      const blacks=[0,1,3,4,5]; if(blacks.includes(w%7)){ const bsemi = semi+1; const bmidi=12*(octave+1)+bsemi; const b=document.createElement('div'); b.className='black'; b.style.left=(x*36)+'px'; b.onmousedown=()=>playKey(bmidi); b.ontouchstart=(e)=>{e.preventDefault(); playKey(bmidi);} ; kb.appendChild(b); }
      x++; }
  }

  function playKey(midi){ if(!ctx) return; const t=ctx.currentTime; playVoiced(midi, t, 0.25); if(isPlaying && overdub.checked){ const step=current16; const arr=extra[step]; if(!arr.includes(midi)) arr.push(midi); const cell=grids.mel.children[step]; cell.classList.add('on'); }
  }

  // ===== CPU Meter =====
  function startCpuMeter(){ const buflen=outAnalyser.fftSize; const data=new Uint8Array(buflen); function tick(){ if(!outAnalyser) return; outAnalyser.getByteTimeDomainData(data); let sum=0; for(let i=0;i<buflen;i++) sum+=Math.abs(data[i]-128); const act=clamp((sum/buflen)/20,0,1); $('cpubar').style.width=(act*100).toFixed(0)+'%'; requestAnimationFrame(tick);} requestAnimationFrame(tick); }

  // ===== Recording =====
  let isRec=false, chunks=[]; function toggleRec(){ if(!isRec){ chunks=[]; mediaRec=new MediaRecorder(mediaDest.stream); mediaRec.ondataavailable=e=>{ if(e.data.size>0) chunks.push(e.data); }; mediaRec.onstop=()=>{ const blob=new Blob(chunks,{type:'audio/webm'}); const url=URL.createObjectURL(blob); dl.href=url; dl.textContent='Download last take'; dl.style.display='inline-block'; dl.download='random-studio.webm'; }; mediaRec.start(); isRec=true; recBtn.textContent='‚èπÔ∏è Stop'; } else { isRec=false; recBtn.textContent='‚è∫Ô∏è Record'; mediaRec.stop(); } }

  // ===== Bindings =====
  bpm.oninput=()=>{bpmVal.textContent=bpm.value}; swing.oninput=()=>{swingVal.textContent=swing.value}; humMs.oninput=()=>{humMsVal.textContent=humMs.value}; humVel.oninput=()=>{humVelVal.textContent=parseFloat(humVel.value).toFixed(2)};
  master.oninput=()=>{ if(masterG) masterG.gain.value=parseFloat(master.value); masterVal.textContent=parseFloat(master.value).toFixed(2)};
  dlyMix.oninput=()=>{ if(dlyGain) dlyGain.gain.value=parseFloat(dlyMix.value); dlyMixVal.textContent=parseFloat(dlyMix.value).toFixed(2)};
  revMix.oninput=()=>{ if(revGain) revGain.gain.value=parseFloat(revMix.value); revMixVal.textContent=parseFloat(revMix.value).toFixed(2)};
  choMix.oninput=()=>{ if(choGain) choGain.gain.value=parseFloat(choMix.value); choMixVal.textContent=parseFloat(choMix.value).toFixed(2)};
  leadVol.oninput=()=>{ leadVolVal.textContent=parseFloat(leadVol.value).toFixed(2) };
  melDen.oninput=()=>{ melDenVal.textContent=parseFloat(melDen.value).toFixed(2)}; melRange.oninput=()=>{ melRangeVal.textContent=melRange.value}; melGate.oninput=()=>{ melGateVal.textContent=parseFloat(melGate.value).toFixed(2)};

  $('drmRnd').onclick=()=>randomDrums(); $('drmClr').onclick=()=>{ Object.values(drums).forEach(r=>r.fill(false)); renderGrids(); };
  $('melRnd').onclick=()=>randomMel(); $('melClr').onclick=()=>{ melody.fill(null); extra.forEach(a=>a.length=0); renderGrids(); };
  $('melRepeat').onclick=()=>{ repeatOn=!repeatOn; $('repeatState').textContent= repeatOn? 'On':'One-shot'; };

  $('kbOct').oninput=()=>renderKeyboard();

  $('startBtn').onclick=async()=>{ await initAudio(); if(ctx.state==='suspended') await ctx.resume(); start(); }
  $('stopBtn').onclick=()=>stop();
  recBtn.onclick=()=>{ if(!ctx) return; toggleRec(); };
  rndAll.onclick=()=>{ rootSel.value=Math.floor(Math.random()*12); scaleSel.value=pick(Object.keys(scales)); leadInst.value=pick(['sawtooth','sine','square','triangle','supersaw','pluck','fm','noise']); octNum.value = 3 + Math.floor(Math.random()*3); bpm.value=90+Math.floor(Math.random()*80); bpmVal.textContent=bpm.value; randomDrums(); randomMel(); };

  // init grids and keyboard
  renderGrids(); renderKeyboard(); randomDrums(); randomMel();

  // mobile resume guard
  ['touchstart','pointerdown','keydown'].forEach(ev=>window.addEventListener(ev, async()=>{ if(ctx && ctx.state==='suspended') await ctx.resume(); }, {passive:true}));
})();
</script>
</body>
</html>